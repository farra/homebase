#!/usr/bin/env bash
# Install SSH keys from 1Password
# Runs once per machine (run_once_before_) â€” before other chezmoi targets
#
# SSH keys are stable secrets that rarely change. Using run_once instead of
# a template avoids triggering 1Password auth on every chezmoi status/apply.

set -euo pipefail

SSH_DIR="$HOME/.ssh"
PRIVATE_KEY="$SSH_DIR/id_ed25519"
PUBLIC_KEY="$SSH_DIR/id_ed25519.pub"

# Skip if keys already exist (idempotent)
if [[ -f "$PRIVATE_KEY" && -f "$PUBLIC_KEY" ]]; then
    echo "SSH keys already installed, skipping"
    exit 0
fi

echo "Installing SSH keys from 1Password..."

mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

op read "op://Private/{{ .op_ssh_key }}/private key" > "$PRIVATE_KEY"
chmod 600 "$PRIVATE_KEY"

op read "op://Private/{{ .op_ssh_key }}/public key" > "$PUBLIC_KEY"
chmod 644 "$PUBLIC_KEY"

echo "SSH keys installed to $SSH_DIR"
