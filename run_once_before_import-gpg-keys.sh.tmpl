#!/usr/bin/env bash
# Import GPG keys for authinfo encryption from 1Password
# Runs once before other chezmoi targets (run_once_before_)

set -euo pipefail

GPG_KEY_FPR="{{ .gpg_key_fingerprint }}"

# Skip if key is already in the keyring
if gpg --list-secret-keys "$GPG_KEY_FPR" &>/dev/null; then
    echo "GPG key $GPG_KEY_FPR already imported, skipping"
    exit 0
fi

echo "Importing GPG keys from 1Password..."

# Import public key
op read "op://Private/{{ .op_gpg_key }}/homebase-authinfo-public.asc" | \
    gpg --batch --import

# Import secret key
op read "op://Private/{{ .op_gpg_key }}/homebase-authinfo-secret.asc" | \
    gpg --batch --import

# Set ultimate trust (it's our own key)
echo "${GPG_KEY_FPR}:6:" | gpg --batch --import-ownertrust

echo "GPG key imported and trusted: $GPG_KEY_FPR"
