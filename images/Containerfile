# Homebase baked image
#
# All dev tools pre-installed via Nix flake.
# Use with distrobox on Bazzite/WSL.
#
# Build:
#   podman build -t ghcr.io/farra/homebase:latest -f images/Containerfile .
#
# Run with distrobox:
#   distrobox create --image ghcr.io/farra/homebase:latest --name home
#   distrobox enter home

ARG BASE_IMAGE=registry.fedoraproject.org/fedora-toolbox:43
ARG FLAKE_ENV=homebase-base-env
FROM ${BASE_IMAGE}

LABEL com.github.containers.toolbox="true"
LABEL org.opencontainers.image.source="https://github.com/farra/homebase"
LABEL org.opencontainers.image.description="Homebase development environment"

# System-level GUI dependencies for Nix-installed apps (Emacs)
# fontconfig: font discovery config at /etc/fonts/fonts.conf
# gsettings-desktop-schemas: GSettings schemas for GTK apps
RUN dnf install -y fontconfig gsettings-desktop-schemas && dnf clean all

# Install Nix using Determinate Systems installer
# --init none: no systemd integration (not available during build)
# --no-confirm: non-interactive
# --extra-conf "sandbox = false": disable sandbox (can't set hostname in container builds)
RUN curl -L https://install.determinate.systems/nix | sh -s -- install linux \
    --no-confirm \
    --init none \
    --extra-conf "sandbox = false"

# Set up environment for nix commands
ENV PATH="/nix/var/nix/profiles/default/bin:$PATH"

# Copy flake into image and install all tools
COPY flake.nix flake.lock /tmp/homebase-flake/
RUN cd /tmp/homebase-flake && \
    nix profile install .#${FLAKE_ENV} \
        --extra-experimental-features "nix-command flakes" && \
    rm -rf /tmp/homebase-flake

# Add nix profile to default PATH for all users
RUN echo 'export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:$PATH"' > /etc/profile.d/nix.sh && \
    echo 'export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:$PATH"' >> /etc/bashrc

# Make Nix-installed zsh available at standard paths
# Distrobox inherits host $SHELL (e.g. /usr/bin/zsh) â€” it must resolve inside the container
RUN ln -sf /nix/var/nix/profiles/default/bin/zsh /usr/bin/zsh && \
    ln -sf /nix/var/nix/profiles/default/bin/zsh /bin/zsh && \
    echo /usr/bin/zsh >> /etc/shells

ENV SHELL=/usr/bin/zsh

CMD ["/usr/bin/zsh"]
