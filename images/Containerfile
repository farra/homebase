# Homebase baked image
#
# All dev tools pre-installed via Nix flake.
# Use with distrobox on Bazzite/WSL.
#
# Build:
#   podman build -t ghcr.io/farra/homebase:latest -f images/Containerfile .
#
# Run with distrobox:
#   distrobox create --image ghcr.io/farra/homebase:latest --name home
#   distrobox enter home

ARG BASE_IMAGE=registry.fedoraproject.org/fedora-toolbox:43
ARG FLAKE_ENV=homebase-base-env
FROM ${BASE_IMAGE}

# Re-declare build args inside the build stage (ARGs before FROM go out of scope)
ARG FLAKE_ENV=homebase-base-env
ARG DNF_PACKAGES=""
ARG GODOT_VERSION=""

LABEL com.github.containers.toolbox="true"
LABEL org.opencontainers.image.source="https://github.com/farra/homebase"
LABEL org.opencontainers.image.description="Homebase development environment"

# System-level GUI dependencies for apps not built by Nix
# Nix-built apps (Emacs) bundle their own libs; directly-downloaded binaries
# (Godot, Electron/Claude Desktop) need system libs at runtime.
# gtk3: pulls in cairo, pango, at-spi2-core, libX*, libxcb, cups-libs, etc.
# nss: Mozilla crypto/network libs needed by Chromium/Electron
# Already in fedora-toolbox: systemd-libs (libudev), vulkan-loader
RUN dnf install -y \
    fontconfig gsettings-desktop-schemas \
    gtk3 nss \
    alsa-lib pulseaudio-libs speech-dispatcher-libs \
    libglvnd-egl libglvnd-glx libglvnd-gles \
    libXinerama libwayland-cursor \
    mesa-libgbm libnotify pciutils-libs \
    && dnf clean all

# Profile-specific DNF packages (e.g. dotnet-sdk for Godot C# support)
RUN if [ -n "$DNF_PACKAGES" ]; then dnf install -y $DNF_PACKAGES && dnf clean all; fi

# Godot Engine from official GitHub releases (if version specified)
# Downloaded directly to get latest builds; Fedora/Nix packages lag behind
# and Nix-built Godot can't access host GPU drivers.
RUN if [ -n "$GODOT_VERSION" ]; then \
    GODOT_BASE="https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable" && \
    mkdir -p /opt/godot && \
    # GDScript editor
    curl -fsSL "${GODOT_BASE}/Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip" -o /tmp/godot.zip && \
    unzip -q /tmp/godot.zip -d /opt/godot/ && \
    chmod +x "/opt/godot/Godot_v${GODOT_VERSION}-stable_linux.x86_64" && \
    ln -sf "/opt/godot/Godot_v${GODOT_VERSION}-stable_linux.x86_64" /usr/local/bin/godot && \
    # .NET/C# editor
    curl -fsSL "${GODOT_BASE}/Godot_v${GODOT_VERSION}-stable_mono_linux_x86_64.zip" -o /tmp/godot-mono.zip && \
    unzip -q /tmp/godot-mono.zip -d /opt/godot/ && \
    chmod +x "/opt/godot/Godot_v${GODOT_VERSION}-stable_mono_linux_x86_64/Godot_v${GODOT_VERSION}-stable_mono_linux.x86_64" && \
    ln -sf "/opt/godot/Godot_v${GODOT_VERSION}-stable_mono_linux_x86_64/Godot_v${GODOT_VERSION}-stable_mono_linux.x86_64" /usr/local/bin/godot-mono && \
    # Export templates
    curl -fsSL "${GODOT_BASE}/Godot_v${GODOT_VERSION}-stable_export_templates.tpz" -o /tmp/godot-templates.tpz && \
    mkdir -p "/opt/godot/export_templates/${GODOT_VERSION}.stable" && \
    unzip -q /tmp/godot-templates.tpz -d /tmp/godot-tpl && \
    mv /tmp/godot-tpl/templates/* "/opt/godot/export_templates/${GODOT_VERSION}.stable/" && \
    rm -rf /tmp/godot*.zip /tmp/godot-mono.zip /tmp/godot-templates.tpz /tmp/godot-tpl && \
    echo "Godot ${GODOT_VERSION} installed to /opt/godot/"; \
fi

# Install Nix using Determinate Systems installer
# --init none: no systemd integration (not available during build)
# --no-confirm: non-interactive
# --extra-conf "sandbox = false": disable sandbox (can't set hostname in container builds)
RUN curl -L https://install.determinate.systems/nix | sh -s -- install linux \
    --no-confirm \
    --init none \
    --extra-conf "sandbox = false"

# Set up environment for nix commands
ENV PATH="/nix/var/nix/profiles/default/bin:$PATH"

# Copy flake into image and install all tools
COPY flake.nix flake.lock homebase.toml /tmp/homebase-flake/
RUN cd /tmp/homebase-flake && \
    nix profile install .#${FLAKE_ENV} \
        --extra-experimental-features "nix-command flakes" && \
    rm -rf /tmp/homebase-flake

# Add nix profile to default PATH for all users
RUN echo 'export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:$PATH"' > /etc/profile.d/nix.sh && \
    echo 'export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:$PATH"' >> /etc/bashrc

# Make Nix-installed zsh available at standard paths
# Distrobox inherits host $SHELL (e.g. /usr/bin/zsh) â€” it must resolve inside the container
RUN ln -sf /nix/var/nix/profiles/default/bin/zsh /usr/bin/zsh && \
    ln -sf /nix/var/nix/profiles/default/bin/zsh /bin/zsh && \
    echo /usr/bin/zsh >> /etc/shells

ENV SHELL=/usr/bin/zsh

CMD ["/usr/bin/zsh"]
