# justfile - Post-bootstrap setup for inside a container
#
# Run these after entering a distrobox for the first time.
# Lives at ~/.homebase/justfile, shared across all containers via $HOME.
#
# Usage:
#   cd ~/.homebase && just setup         # full first-time setup
#   cd ~/.homebase && just doom-sync     # after config changes
#   cd ~/.homebase && just update-agents # update AI tools

default:
    @just --list

# ── First-Time Setup ─────────────────────────────────────────────────────────

# Full first-time setup (run once after entering a new container)
setup: doom-install install-agents
    @echo ""
    @echo "Setup complete!"
    @echo "  - Doom Emacs installed (run 'doom sync' after config changes)"
    @echo "  - AI agents installed (claude, codex, gemini)"

# ── Doom Emacs ───────────────────────────────────────────────────────────────

# Install Doom Emacs (clone + install)
doom-install:
    #!/usr/bin/env bash
    set -euo pipefail
    if [[ -d "$HOME/.emacs.d/bin" ]]; then
        echo "Doom Emacs already installed at ~/.emacs.d"
        echo "Run 'just doom-reinstall' to force reinstall"
        exit 0
    fi
    # Back up any existing .emacs.d
    if [[ -d "$HOME/.emacs.d" ]]; then
        echo "Backing up existing ~/.emacs.d to ~/.emacs.d.bak"
        mv "$HOME/.emacs.d" "$HOME/.emacs.d.bak"
    fi
    echo "Cloning Doom Emacs..."
    git clone --depth 1 https://github.com/doomemacs/doomemacs "$HOME/.emacs.d"
    echo "Running doom install..."
    "$HOME/.emacs.d/bin/doom" install
    echo "Doom Emacs installed. Config at ~/.config/doom/ (managed by chezmoi)"

# Reinstall Doom Emacs from scratch
doom-reinstall:
    rm -rf "$HOME/.emacs.d"
    just doom-install

# Sync Doom Emacs (after config changes)
doom-sync:
    ~/.emacs.d/bin/doom sync

# Run Doom doctor
doom-doctor:
    ~/.emacs.d/bin/doom doctor

# Export Emacs to host desktop (distrobox only)
doom-export:
    distrobox-export --app emacs 2>/dev/null || echo "Not in a distrobox?"

# ── AI Agents ────────────────────────────────────────────────────────────────

# Install all AI agent CLIs
install-agents: install-claude install-codex install-gemini

# Install Claude Code
install-claude:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v claude &>/dev/null; then
        echo "Claude Code already installed: $(claude --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-claude' to update"
        exit 0
    fi
    echo "Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
    echo "Claude Code installed"

# Install Codex CLI
install-codex:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v codex &>/dev/null; then
        echo "Codex already installed: $(codex --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-codex' to update"
        exit 0
    fi
    echo "Installing Codex CLI..."
    curl -fsSL https://raw.githubusercontent.com/openai/codex/main/install.sh | bash
    echo "Codex CLI installed"

# Install Gemini CLI
install-gemini:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v gemini &>/dev/null; then
        echo "Gemini CLI already installed: $(gemini --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-gemini' to update"
        exit 0
    fi
    echo "Installing Gemini CLI..."
    curl -fsSL https://raw.githubusercontent.com/google-gemini/gemini-cli/main/install.sh | bash
    echo "Gemini CLI installed"

# Update all AI agent CLIs
update-agents: update-claude update-codex update-gemini

# Update Claude Code
update-claude:
    curl -fsSL https://claude.ai/install.sh | bash

# Update Codex CLI
update-codex:
    curl -fsSL https://raw.githubusercontent.com/openai/codex/main/install.sh | bash

# Update Gemini CLI
update-gemini:
    curl -fsSL https://raw.githubusercontent.com/google-gemini/gemini-cli/main/install.sh | bash
