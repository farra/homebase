# justfile - Homebase user commands
#
# For living IN homebase (setup, updates, day-to-day use).
# Lives at ~/.homebase/justfile, shared across host and all containers via $HOME.
#
# Usage:
#   cd ~/.homebase && just setup         # full first-time setup
#   cd ~/.homebase && just update        # update everything
#   homebase                             # shell alias for cd ~/.homebase && just

registry := "ghcr.io/farra"
image_name := "homebase"
runtime := `command -v podman 2>/dev/null || command -v docker 2>/dev/null || echo ""`

default:
    @just --list

# ── First-Time Setup ─────────────────────────────────────────────────────

# Full first-time setup
setup: setup-workspace doom-install install-agents
    @echo ""
    @echo "Setup complete!"
    @echo "  - Workspace directories created"
    @echo "  - Doom Emacs installed (run 'just doom-sync' after config changes)"
    @echo "  - AI agents installed (claude, codex, gemini)"

# ── Workspace ────────────────────────────────────────────────────────────

# Create workspace directory structure
setup-workspace:
    @echo "Creating workspace directories..."
    mkdir -p ~/dev/.worktrees ~/dev/me ~/dev/jmt ~/dev/ref
    @echo "  ~/dev/.worktrees/  — bare clones"
    @echo "  ~/dev/me/          — github.com/farra"
    @echo "  ~/dev/jmt/         — github.com/jamandtea"
    @echo "  ~/dev/ref/         — third-party / reference"

# ── Worktrees ────────────────────────────────────────────────────────────
# Bare clones in ~/dev/.worktrees/, worktrees in group dirs.
# Each worktree = one branch = one agent session.

# Bare-clone a repo into ~/dev/.worktrees/
# Usage: homebase clone farra/projectA
clone repo:
    #!/usr/bin/env bash
    set -euo pipefail
    name="$(basename '{{repo}}')"
    dest="$HOME/dev/.worktrees/${name}.git"
    if [[ -d "$dest" ]]; then
        echo "Already cloned: $dest"
        exit 0
    fi
    git clone --bare "git@github.com:{{repo}}.git" "$dest"
    git -C "$dest" config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
    git -C "$dest" fetch origin
    echo "Cloned: $dest"

# List bare clones
clones:
    @ls -1 "$HOME/dev/.worktrees/" 2>/dev/null | sed 's/\.git$//' || echo "(none)"

# Create a worktree from a bare clone
# Usage: homebase wt projectA fix-auth [group]
wt project branch group="me":
    #!/usr/bin/env bash
    set -euo pipefail
    bare="$HOME/dev/.worktrees/{{project}}.git"
    dest="$HOME/dev/{{group}}/{{project}}-{{branch}}"
    if [[ ! -d "$bare" ]]; then
        echo "No bare clone found: $bare"
        echo "Run: homebase clone <org>/{{project}}"
        exit 1
    fi
    if [[ -d "$dest" ]]; then
        echo "Worktree already exists: $dest"
        exit 0
    fi
    git -C "$bare" worktree add "$dest" -b "{{branch}}"
    echo "Created: $dest (branch: {{branch}})"

# Create a worktree from an existing remote branch
wt-checkout project branch group="me":
    #!/usr/bin/env bash
    set -euo pipefail
    bare="$HOME/dev/.worktrees/{{project}}.git"
    dest="$HOME/dev/{{group}}/{{project}}-{{branch}}"
    if [[ ! -d "$bare" ]]; then
        echo "No bare clone found: $bare"
        exit 1
    fi
    git -C "$bare" fetch origin
    git -C "$bare" worktree add "$dest" "{{branch}}"
    echo "Checked out: $dest (branch: {{branch}})"

# Remove a worktree (keeps the branch)
wt-rm path:
    #!/usr/bin/env bash
    set -euo pipefail
    target="$HOME/dev/{{path}}"
    if [[ ! -d "$target" ]]; then
        echo "Not found: $target"
        exit 1
    fi
    bare="$(git -C "$target" rev-parse --git-common-dir 2>/dev/null)" || true
    if [[ -n "$bare" && -d "$bare" ]]; then
        git -C "$bare" worktree remove "$target"
        echo "Removed worktree: $target"
    else
        echo "Not a git worktree: $target"
        exit 1
    fi

# List all active worktrees across all bare clones
wts:
    #!/usr/bin/env bash
    for bare in "$HOME/dev/.worktrees/"*.git; do
        [[ -d "$bare" ]] || continue
        name="$(basename "$bare" .git)"
        trees="$(git -C "$bare" worktree list | tail -n +2)"
        if [[ -n "$trees" ]]; then
            echo "── $name ──"
            echo "$trees"
            echo ""
        fi
    done

# ── Updates ──────────────────────────────────────────────────────────────

# Update everything (dotfiles + agents, and host tools if on host)
update: update-dotfiles update-host update-agents
    @echo ""
    @echo "All updates complete."

# Pull and apply latest dotfiles
update-dotfiles:
    chezmoi update

# Update host tools (Homebrew) — skipped inside distrobox
update-host:
    #!/usr/bin/env bash
    set -euo pipefail
    if [[ -f /run/.containerenv ]]; then
        echo "Inside a container — skipping host tool update."
        echo "Run this on the host to update Homebrew."
        exit 0
    fi
    brew update && brew upgrade

# ── Distrobox Lifecycle ──────────────────────────────────────────────────

# Create the homebase distrobox
distrobox-create:
    #!/usr/bin/env bash
    set -euo pipefail
    if [[ -z "{{runtime}}" ]]; then
        echo "ERROR: Neither podman nor docker found. Install one first."
        exit 1
    fi
    {{runtime}} pull {{registry}}/{{image_name}}:latest
    # Mount host Homebrew if installed to /home/linuxbrew (not in $HOME)
    VOLUME_FLAGS=""
    if [[ -d "/home/linuxbrew" ]]; then
        VOLUME_FLAGS="--volume /home/linuxbrew:/home/linuxbrew"
    fi
    distrobox create --image {{registry}}/{{image_name}}:latest --name home $VOLUME_FLAGS

# Enter the homebase distrobox
distrobox-enter:
    distrobox enter home

# Remove the homebase distrobox
distrobox-rm:
    distrobox rm home --force

# Rebuild distrobox from latest image (pulls fresh, recreates)
distrobox-rebuild: distrobox-rm distrobox-create
    @echo "Distrobox 'home' rebuilt from latest image."
    @echo "Run 'just distrobox-enter' to enter."

# ── Doom Emacs ───────────────────────────────────────────────────────────

# Install Doom Emacs (clone + install)
doom-install:
    #!/usr/bin/env bash
    set -euo pipefail
    if [[ -d "$HOME/.emacs.d/bin" ]]; then
        echo "Doom Emacs already installed at ~/.emacs.d"
        echo "Run 'just doom-reinstall' to force reinstall"
        exit 0
    fi
    # Back up any existing .emacs.d
    if [[ -d "$HOME/.emacs.d" ]]; then
        echo "Backing up existing ~/.emacs.d to ~/.emacs.d.bak"
        mv "$HOME/.emacs.d" "$HOME/.emacs.d.bak"
    fi
    echo "Cloning Doom Emacs..."
    git clone --depth 1 https://github.com/doomemacs/doomemacs "$HOME/.emacs.d"
    echo "Running doom install..."
    "$HOME/.emacs.d/bin/doom" install
    echo "Doom Emacs installed. Config at ~/.config/doom/ (managed by chezmoi)"

# Reinstall Doom Emacs from scratch
doom-reinstall:
    rm -rf "$HOME/.emacs.d"
    just doom-install

# Sync Doom Emacs (after config changes)
doom-sync:
    ~/.emacs.d/bin/doom sync

# Run Doom doctor
doom-doctor:
    ~/.emacs.d/bin/doom doctor

# Export Emacs to host desktop (distrobox only)
doom-export:
    distrobox-export --app emacs 2>/dev/null || echo "Not in a distrobox?"

# ── AI Agents ────────────────────────────────────────────────────────────

# Install all AI agent CLIs
install-agents: install-claude install-codex install-gemini

# Install Claude Code
install-claude:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v claude &>/dev/null; then
        echo "Claude Code already installed: $(claude --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-claude' to update"
        exit 0
    fi
    echo "Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
    echo "Claude Code installed"

# Install Codex CLI
install-codex:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v codex &>/dev/null; then
        echo "Codex already installed: $(codex --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-codex' to update"
        exit 0
    fi
    echo "Installing Codex CLI..."
    brew install codex
    echo "Codex CLI installed"

# Install Gemini CLI
install-gemini:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v gemini &>/dev/null; then
        echo "Gemini CLI already installed: $(gemini --version 2>/dev/null || echo 'unknown version')"
        echo "Run 'just update-gemini' to update"
        exit 0
    fi
    echo "Installing Gemini CLI..."
    brew install gemini-cli
    echo "Gemini CLI installed"

# Update all AI agent CLIs
update-agents: update-claude update-codex update-gemini

# Update Claude Code
update-claude:
    curl -fsSL https://claude.ai/install.sh | bash

# Update Codex CLI
update-codex:
    brew upgrade codex || brew install codex

# Update Gemini CLI
update-gemini:
    brew upgrade gemini-cli || brew install gemini-cli
