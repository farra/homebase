# Containerfile.slim - Slim distrobox image with Nix pre-installed
# Tools are installed via `just bootstrap` on first run

FROM registry.fedoraproject.org/fedora:41

# Install minimal base tools
RUN dnf install -y \
    zsh \
    git \
    curl \
    just \
    && dnf clean all

# Install Nix (Determinate Systems installer)
# Using --init none because distrobox handles init
RUN curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | \
    sh -s -- install linux --init none --no-confirm

# Copy homebase config (so bootstrap knows what to install)
COPY homebase.toml /etc/homebase/
COPY justfile /etc/skel/.config/homebase/

# Add bootstrap check to shell RC
RUN echo 'if [ ! -f ~/.homebase-bootstrapped ]; then' >> /etc/skel/.zshrc && \
    echo '    echo "First run detected. Run: just bootstrap"' >> /etc/skel/.zshrc && \
    echo 'fi' >> /etc/skel/.zshrc && \
    echo '' >> /etc/skel/.zshrc && \
    echo '# Source Nix' >> /etc/skel/.zshrc && \
    echo 'if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then' >> /etc/skel/.zshrc && \
    echo '    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' >> /etc/skel/.zshrc && \
    echo 'fi' >> /etc/skel/.zshrc

# Set default shell
ENV SHELL=/bin/zsh

# Labels for distrobox compatibility
LABEL com.github.containers.toolbox="true"
